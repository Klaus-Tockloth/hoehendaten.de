<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dienst - Histogramm-Analyse</title>
  <meta name="description" content=
  "Generieren Sie Histogramme für verschiedene topographische Abbildungen (Höhendaten, Hangneigung, Hangexposition, Geländerauheit, TRI, TPI) basierend auf Koordinaten für einen 1x1 km Kartenausschnitt in Deutschland.">
  <meta name="keywords" content=
  "Höhendaten, Histogramm, Hangneigung, Hangexposition, Geländerauheit, TRI, TPI, DGM, UTM, Lon/Lat, Analyse, Statistik, Geodaten, Deutschland">
  <meta name="robots" content="index, follow">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Purpose: Lokale Stile exklusiv für 'dienst-histogramm.html'. */

    /* Überschreibt die globalen .results-table-Regeln für die Standard-Ergebnistabellen (2 Spalten), wendet sie aber NICHT auf die .histogram-entries-table an. */
    .results-table:not(.histogram-entries-table) th:first-child,
    .results-table:not(.histogram-entries-table) td:first-child {
      width: 30%;
    }

    .results-table:not(.histogram-entries-table) th:nth-child(2),
    .results-table:not(.histogram-entries-table) td:nth-child(2) {
      width: 70%;
    }

    .histogram-entries-table {
      table-layout: auto;
    }

    /* Setzt die Breite für die .histogram-entries-table zurück, damit der Browser sie automatisch anpasst. */
    .histogram-entries-table.results-table th,
    .histogram-entries-table.results-table td {
      width: auto;
      padding: 4px 6px;
    }

    /* Accordion Styles */
    .accordion {
        background-color: #eee;
        color: #444;
        cursor: pointer;
        padding: 10px 18px;
        width: 100%;
        border: none;
        text-align: left;
        outline: none;
        font-size: 15px;
        transition: 0.4s;
        border-bottom: 1px solid #ddd;
        margin-top: 5px;
        box-sizing: border-box;
    }

    .accordion.active, .accordion:hover {
        background-color: #ccc;
    }

    .accordion:after {
        content: '\002B'; /* Plus-Zeichen */
        color: #777;
        font-weight: bold;
        float: right;
        margin-left: 5px;
    }

    .accordion.active:after {
        content: "\2212"; /* Minus-Zeichen */
    }

    .panel {
        padding: 0 18px;
        background-color: white;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.2s ease-out;
    }

    .panel table {
        width: 100%;
        margin-bottom: 10px;
    }

    /* Removed radio-group specific styles */
    /* .input-group.radio-group {
        margin-top: 15px;
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
    }

    .input-group.radio-group label {
        display: inline-block;
        margin-right: 15px;
        font-weight: normal;
    }

    .input-group.radio-group input[type="radio"] {
        margin-right: 5px;
    } */

    .input-group input[type="text"],
    .input-group input[type="number"],
    .input-group select {
      width: calc(100% - 10px);
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <nav>
    <ul>
      <li>
        <a href="index.html">Start</a>
      </li>

      <li>
        <a href="karte.html">Karte</a>
      </li>

      <li class="dropdown">
        <a href="javascript:void(0);" class="dropbtn">Abbildungen&nbsp;›</a>
        <ul class="dropdown-content">
          <li>
            <a href="abbildung-allgemein.html">Allgemein</a>
          </li>

          <li>
            <a href="abbildung-hoehenschichtlinien.html">Höhenschichtlinien</a>
          </li>

          <li>
            <a href="abbildung-schummerung.html">Schummerung</a>
          </li>

          <li>
            <a href="abbildung-kolorierung.html">Kolorierung</a>
          </li>

          <li>
            <a href="abbildung-farbrelief.html">Farbrelief</a>
          </li>

          <li>
            <a href="abbildung-hangneigung.html">Hangneigung</a>
          </li>

          <li>
            <a href="abbildung-hangexposition.html">Hangexposition</a>
          </li>

          <li>
            <a href="abbildung-gelaenderauheit.html">Geländerauheit</a>
          </li>

          <li>
            <a href="abbildung-tri.html">TRI (Ruggedness)</a>
          </li>

          <li>
            <a href="abbildung-tpi.html">TPI (Position)</a>
          </li>
        </ul>
      </li>

      <li>
        <a href="grundlagen.html">Grundlagen</a>
      </li>

      <li class="dropdown">
        <a href="javascript:void(0);" class="dropbtn">Dienste&nbsp;›</a>
        <ul class="dropdown-content">
          <li>
            <a href="dienst-punkt.html">Punkt Lon / Lat</a>
          </li>

          <li>
            <a href="dienst-punkt_utm.html">Punkt UTM</a>
          </li>

          <li>
            <a href="dienst-quelldaten.html">Quelldaten GeoTIFF</a>
          </li>

          <li>
            <a href="dienst-gpx.html">GPX-Datei</a>
          </li>

          <li>
            <a href="dienst-gpx-analyse.html">GPX-Analyse</a>
          </li>

          <li>
            <a href="dienst-hoehenschichtlinien.html">Höhenschichtlinien</a>
          </li>

          <li>
            <a href="dienst-schummerung.html">Schummerung</a>
          </li>

          <li>
            <a href="dienst-kolorierung.html">Kolorierung</a>
          </li>

          <li>
            <a href="dienst-histogramm.html">Histogramm</a>
          </li>

          <li>
            <a href="dienst-farbrelief.html">Farbrelief</a>
          </li>

          <li>
            <a href="dienst-hangneigung.html">Hangneigung</a>
          </li>

          <li>
            <a href="dienst-hangexposition.html">Hangexposition</a>
          </li>

          <li>
            <a href="dienst-gelaenderauheit.html">Geländerauheit</a>
          </li>

          <li>
            <a href="dienst-tri.html">TRI (Ruggedness)</a>
          </li>

          <li>
            <a href="dienst-tpi.html">TPI (Position)</a>
          </li>
        </ul>
      </li>

      <li class="dropdown">
        <a href="javascript:void(0);" class="dropbtn">API&nbsp;›</a>
        <ul class="dropdown-content">
          <li>
            <a href="api-allgemein.html">Allgemein</a>
          </li>

          <li>
            <a href="api-pointrequest.html">PointRequest</a>
          </li>

          <li>
            <a href="api-utmpointrequest.html">UTMPointRequest</a>
          </li>

          <li>
            <a href="api-rawtifrequest.html">RawTIFRequest</a>
          </li>

          <li>
            <a href="api-gpxrequest.html">GPXRequest</a>
          </li>

          <li>
            <a href="api-gpxanalyzerequest.html">GPXAnalyseRequest</a>
          </li>

          <li>
            <a href="api-histogramrequest.html">HistogramRequest</a>
          </li>

          <li>
            <a href="api-contoursrequest.html">ContoursRequest</a>
          </li>

          <li>
            <a href="api-hillshaderequest.html">HillshadeRequest</a>
          </li>

          <li>
            <a href="api-colorreliefrequest.html">ColorReliefRequest</a>
          </li>

          <li>
            <a href="api-sloperequest.html">SlopeRequest</a>
          </li>

          <li>
            <a href="api-aspectrequest.html">AspectRequest</a>
          </li>

          <li>
            <a href="api-roughnessrequest.html">RoughnessRequest</a>
          </li>

          <li>
            <a href="api-trirequest.html">TRIRequest</a>
          </li>

          <li>
            <a href="api-tpirequest.html">TPIRequest</a>
          </li>
        </ul>
      </li>

      <li>
        <a href="impressum.html">Impressum</a>
      </li>
    </ul>
  </nav>

  <div class="container">
    <h3>Histogramm-Analyse für einen Kartenausschnitt von 1x1 km</h3>

    <p>Der Referenzpunkt kann in den Koordinatensystemen Lon/Lat oder UTM angegeben werden. Das Histogramm wird für die Kachel generiert, in der sich der
    Referenzpunkt befindet.</p>
    <!-- Bereich für die Eingabefelder -->

    <div class="input-section section-box">
      <p>Option 1: Lon/Lat-Koordinaten</p>
      <!-- Hegekopf, Edersee, Hessen -->

      <div class="input-group">
        <label for="longitude">Longitude</label> <input type="text" id="longitude" value="8.964229">
      </div>

      <div class="input-group">
        <label for="latitude">Latitude</label> <input type="text" id="latitude" value="51.185913">
      </div>

      <hr style="border-top: 1px solid #ddd; margin-top: 1em; margin-bottom: 1em;">

      <p>Option 2: UTM-Koordinaten</p>

      <div class="input-group">
        <label for="zone">Zone</label> <input type="number" id="zone" value="" min="32" max="33">
      </div>

      <div class="input-group">
        <label for="easting">Easting</label> <input type="text" id="easting" value="">
      </div>

      <div class="input-group">
        <label for="northing">Northing</label> <input type="text" id="northing" value="">
      </div>

      <hr style="border-top: 1px solid #ddd; margin-top: 1em; margin-bottom: 1em;">
      <!-- Changed from radio group to select dropdown -->

      <div class="input-group">
        <label for="visualizationType"><strong>Abbildung</strong></label> <select id="visualizationType">
          <option value="rawtif" selected>
            Höhendaten
          </option>
          <option value="slope">
            Hangneigung
          </option>
          <option value="aspect">
            Hangexposition
          </option>
          <option value="roughness">
            Geländerauheit
          </option>
          <option value="tri">
            TRI (Ruggedness)
          </option>
          <option value="tpi">
            TPI (Position)
          </option>
        </select>
      </div>

      <div class="input-group">
        <label for="gradientAlgorithm">Algorithmus</label> <select id="gradientAlgorithm">
          <option value="Horn">
            Horn
          </option>
          <option value="ZevenbergenThorne">
            ZevenbergenThorne
          </option>
        </select>
      </div>
      <!-- Changed from radio group to select dropdown -->

      <div class="input-group">
        <label for="histogramType"><strong>Histogramm</strong></label> <select id="histogramType">
          <option value="standard" selected>
            Standard
          </option>
          <option value="quantile">
            Quantil
          </option>
        </select>
      </div>

      <div class="input-group">
        <label for="numberOfBins">Klassen</label> <input type="number" id="numberOfBins" value="20" min="1">
      </div>

      <div class="input-group">
        <label for="minValue">Minimalwert</label> <input type="text" id="minValue" value="">
      </div>

      <div class="input-group">
        <label for="maxValue">Maximalwert</label> <input type="text" id="maxValue" value="">
      </div>
    </div>
    <!-- Bereich für den Button -->

    <div class="button-section section-box">
      <button id="queryButton">Histogramm-Analyse starten</button>
    </div>
    <!-- Bereich für die Ausgabe -->

    <div class="output-section section-box">
      <div id="results">
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const longitudeInput = document.getElementById('longitude');
      const latitudeInput = document.getElementById('latitude');
      const zoneInput = document.getElementById('zone');
      const eastingInput = document.getElementById('easting');
      const northingInput = document.getElementById('northing');

      // Changed from querySelectorAll for radios to getElementById for select
      const visualizationTypeSelect = document.getElementById('visualizationType');
      const gradientAlgorithmSelect = document.getElementById('gradientAlgorithm');
      // Changed from querySelectorAll for radios to getElementById for select
      const histogramTypeSelect = document.getElementById('histogramType');
      const numberOfBinsInput = document.getElementById('numberOfBins');
      const minValueInput = document.getElementById('minValue');
      const maxValueInput = document.getElementById('maxValue');

      const queryButton = document.getElementById('queryButton');
      const resultsDiv = document.getElementById('results');

      const apiUrl = 'https://api.hoehendaten.de:14444/v1/histogram';

      function displayResult(className, htmlContent) {
        resultsDiv.className = className;
        resultsDiv.innerHTML = htmlContent;
        activateAccordions(); // Activate accordions after content is loaded
      }

      // Function to activate accordion functionality
      function activateAccordions() {
        const accordions = document.querySelectorAll('.accordion');
        accordions.forEach(accordion => {
          accordion.removeEventListener('click', toggleAccordion); // Prevent duplicate listeners
          accordion.addEventListener('click', toggleAccordion);
        });
      }

      // Function to toggle accordion panel
      function toggleAccordion() {
        this.classList.toggle('active');
        const panel = this.nextElementSibling;
        if (panel.style.maxHeight) {
          panel.style.maxHeight = null;
        } else {
          panel.style.maxHeight = panel.scrollHeight + "px";
        }
      }

      function updateGradientAlgorithmState() {
        // Get value directly from select
        const selectedVisualization = visualizationTypeSelect.value;
        const isSlopeOrAspect = (selectedVisualization === 'slope' || selectedVisualization === 'aspect');
        gradientAlgorithmSelect.disabled = !isSlopeOrAspect;
      }

      // Initial state update
      updateGradientAlgorithmState();

      // Add event listener to the select element
      visualizationTypeSelect.addEventListener('change', updateGradientAlgorithmState);

      queryButton.addEventListener('click', async () => {
        const longitude = parseFloat(longitudeInput.value);
        const latitude = parseFloat(latitudeInput.value);
        const zone = parseInt(zoneInput.value, 10);
        const easting = parseFloat(eastingInput.value);
        const northing = parseFloat(northingInput.value);

        // Get value directly from select
        const selectedVisualizationType = visualizationTypeSelect.value;

        const gradientAlgorithm = gradientAlgorithmSelect.value;
        const isGradientAlgorithmRelevant = (selectedVisualizationType === 'slope' || selectedVisualizationType === 'aspect');

        // Get value directly from select
        const selectedHistogramType = histogramTypeSelect.value;

        const numberOfBins = parseInt(numberOfBinsInput.value, 10);
        const minValue = minValueInput.value.trim();
        const maxValue = maxValueInput.value.trim();

        let useLonLat = !isNaN(longitude) && !isNaN(latitude) && longitudeInput.value.trim() !== "" && latitudeInput.value.trim() !== "";
        let useUtm = !isNaN(zone) && (zone === 32 || zone === 33) && !isNaN(easting) && !isNaN(northing) && zoneInput.value.trim() !== "" && eastingInput.value.trim() !== "" && northingInput.value.trim() !== "";

        if (!useLonLat && !useUtm) {
          displayResult('error', '<p class="status-message">Fehler: Bitte geben Sie entweder gültige Lon/Lat-Koordinaten oder gültige UTM-Koordinaten (Zone 32/33, Easting, Northing) ein.</p>');
          return;
        }

        if (isNaN(numberOfBins) || numberOfBins < 1) {
          displayResult('error', '<p class="status-message">Fehler: Die Anzahl der Klassen muss eine positive ganze Zahl sein.</p>');
          return;
        }

        displayResult('loading', '<p class="status-message">Lade ... Sende Anfrage an den Dienst ...</p>');

        const requestPayload = {
          Type: "HistogramRequest",
          ID: "WebApp-Histogram-" + Date.now() + "-" + Math.random().toString(36).substring(7),
          Attributes: {
            Longitude: useLonLat ? longitude : 0.0,
            Latitude: useLonLat ? latitude : 0.0,
            Zone: useUtm ? zone : 0,
            Easting: useUtm ? easting : 0.0,
            Northing: useUtm ? northing : 0.0,
            TypeOfVisualization: selectedVisualizationType,
            GradientAlgorithm: isGradientAlgorithmRelevant ? gradientAlgorithm : "", // Only send if relevant
            TypeOfHistogram: selectedHistogramType,
            NumberOfBins: numberOfBins,
            MinValue: minValue,
            MaxValue: maxValue
          }
        };

        // If UTM is primary and Lon/Lat is also filled, clear Lon/Lat for the request to avoid ambiguity if the user filled both but intended UTM.
        if (useUtm) {
          requestPayload.Attributes.Longitude = 0.0;
          requestPayload.Attributes.Latitude = 0.0;
        } else if (useLonLat) { // UTM fields were not filled or invalid
          requestPayload.Attributes.Zone = 0;
          requestPayload.Attributes.Easting = 0.0;
          requestPayload.Attributes.Northing = 0.0;
        }

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'Accept-Encoding': 'gzip'
            },
            body: JSON.stringify(requestPayload)
          });

          let data = null;
          let rawText = null;

          try {
            rawText = await response.text();
            data = JSON.parse(rawText);
            console.log("API-Antwort (geparstes JSON):", data);
          } catch (jsonError) {
            console.warn("JSON-Parsen fehlgeschlagen:", jsonError);
            console.log("Rohe Antwort (Text):", rawText);
          }

          if (!response.ok) {
            console.error("HTTP-Fehler:", response.status);
            let errorHtml = `<p class="status-message">Serverfehler mit Status ${response.status}:</p>`;
            if (data && data.Attributes && data.Attributes.IsError === true) {
              const errorAttributes = data.Attributes;
              errorHtml += '<table class="results-table">';
              if (errorAttributes.Error) {
                const errorDetail = errorAttributes.Error;
                if (errorDetail.Code !== undefined) errorHtml += `<tr><td><strong>Fehlercode</strong></td><td>${errorDetail.Code}</td></tr>`;
                if (errorDetail.Title !== undefined) errorHtml += `<tr><td><strong>Fehlertitel</strong></td><td>${errorDetail.Title}</td></tr>`;
                if (errorDetail.Detail !== undefined) errorHtml += `<tr><td><strong>Fehlerdetail</strong></td><td>${errorDetail.Detail}</td></tr>`;
              }
              errorHtml += '</table>';
            } else if (rawText !== null) {
              errorHtml += `<br>Antwort vom Server (Roh):<br><pre>${rawText}</pre>`;
            } else {
              errorHtml += `<br>Konnte die Antwort vom Server nicht lesen.`;
            }
            displayResult('error', errorHtml);
            return;
          }

          if (data && data.Attributes) {
            if (data.Attributes.IsError === true) {
              const errorAttributes = data.Attributes;
              let errorHtml = '<p class="status-message">Erfolgreiche HTTP-Antwort, aber Anwendungsfehler gemeldet.</p>';
              errorHtml += '<table class="results-table">';
              if (errorAttributes.Error) {
                const errorDetail = errorAttributes.Error;
                if (errorDetail.Code !== undefined) errorHtml += `<tr><td><strong>Fehlercode</strong></td><td>${errorDetail.Code}</td></tr>`;
                if (errorDetail.Title !== undefined) errorHtml += `<tr><td><strong>Fehlertitel</strong></td><td>${errorDetail.Title}</td></tr>`;
                if (errorDetail.Detail !== undefined) errorHtml += `<tr><td><strong>Fehlerdetail</strong></td><td>${errorDetail.Detail}</td></tr>`;
              }
              errorHtml += '</table>';
              console.error("API-Anwendungsfehler trotz OK-Antwort:", data.Attributes);
              displayResult('error', errorHtml);
              return;
            }

            let resultsHtml = '<p class="status-message">Histogramm-Analyse erfolgreich:</p>';

            const histogramResult = data.Attributes;

            if (histogramResult) {
              resultsHtml += '<h4>Anfrage-Parameter:</h4>';
              resultsHtml += '<table class="results-table">';
              if (histogramResult.Longitude !== undefined && histogramResult.Longitude !== 0) resultsHtml += `<tr><td><strong>Longitude</strong></td><td>${histogramResult.Longitude}</td></tr>`;
              if (histogramResult.Latitude !== undefined && histogramResult.Latitude !== 0) resultsHtml += `<tr><td><strong>Latitude</strong></td><td>${histogramResult.Latitude}</td></tr>`;
              if (histogramResult.Zone !== undefined && histogramResult.Zone !== 0) resultsHtml += `<tr><td><strong>Zone</strong></td><td>${histogramResult.Zone}</td></tr>`;
              if (histogramResult.Easting !== undefined && histogramResult.Easting !== 0) resultsHtml += `<tr><td><strong>Easting</strong></td><td>${histogramResult.Easting}</td></tr>`;
              if (histogramResult.Northing !== undefined && histogramResult.Northing !== 0) resultsHtml += `<tr><td><strong>Northing</strong></td><td>${histogramResult.Northing}</td></tr>`;
              
              // Mapping internal values to external display names for visualization types
              const visualizationTypeMap = {
                'rawtif': 'Höhendaten',
                'slope': 'Hangneigung',
                'aspect': 'Hangexposition',
                'roughness': 'Geländerauheit',
                'tri': 'TRI (Ruggedness)',
                'tpi': 'TPI (Position)'
              };
              resultsHtml += `<tr><td><strong>Abbildung</strong></td><td>${visualizationTypeMap[histogramResult.TypeOfVisualization] || histogramResult.TypeOfVisualization}</td></tr>`;
              
              if (histogramResult.GradientAlgorithm && histogramResult.GradientAlgorithm !== "") resultsHtml += `<tr><td><strong>Algorithmus</strong></td><td>${histogramResult.GradientAlgorithm}</td></tr>`;
              
              const histogramTypeMap = {
                'standard': 'Standard',
                'quantile': 'Quantil'
              };
              resultsHtml += `<tr><td><strong>Histogramm</strong></td><td>${histogramTypeMap[histogramResult.TypeOfHistogram] || histogramResult.TypeOfHistogram}</td></tr>`;
              resultsHtml += `<tr><td><strong>Klassen</strong></td><td>${histogramResult.NumberOfBins}</td></tr>`;
              if (histogramResult.MinValue !== undefined && histogramResult.MinValue !== "") resultsHtml += `<tr><td><strong>Minimalwert (Anfrage)</strong></td><td>${histogramResult.MinValue}</td></tr>`;
              if (histogramResult.MaxValue !== undefined && histogramResult.MaxValue !== "") resultsHtml += `<tr><td><strong>Maximalwert (Anfrage)</strong></td><td>${histogramResult.MaxValue}</td></tr>`;
              resultsHtml += '</table>';

              if (Array.isArray(histogramResult.Histograms) && histogramResult.Histograms.length > 0) {
                histogramResult.Histograms.forEach((histogram, index) => {
                  resultsHtml += `<hr><h4>Histogramm ${index + 1}</h4>`;
                  resultsHtml += '<table class="results-table">';
                  if (histogram.Actuality !== undefined) resultsHtml += `<tr><td><strong>Aktualität</strong></td><td>${histogram.Actuality}</td></tr>`;
                  if (histogram.Origin !== undefined) resultsHtml += `<tr><td><strong>Ursprung</strong></td><td>${histogram.Origin}</td></tr>`;
                  if (histogram.Attribution !== undefined) resultsHtml += `<tr><td><strong>Attribution</strong></td><td>${histogram.Attribution}</td></tr>`;
                  if (histogram.TileIndex !== undefined) resultsHtml += `<tr><td><strong>Tile Index</strong></td><td>${histogram.TileIndex}</td></tr>`;
                  resultsHtml += '</table>';

                  if (histogram.Statistic) {
                    resultsHtml += `<h4 class="accordion">Statistik anzeigen</h4>`; // Added accordion button for Statistik
                    resultsHtml += `<div class="panel">`; // Added panel div for Statistik content
                    resultsHtml += '<table class="results-table">';
                    if (histogram.Statistic.ValuesTotal !== undefined) resultsHtml += `<tr><td><strong>Werte insgesamt</strong></td><td>${histogram.Statistic.ValuesTotal}</td></tr>`;
                    if (histogram.Statistic.NoValueCount !== undefined) resultsHtml += `<tr><td><strong>Anzahl "Kein Wert"</strong></td><td>${histogram.Statistic.NoValueCount}</td></tr>`;
                    if (histogram.Statistic.NoValuePercent !== undefined) resultsHtml += `<tr><td><strong>Prozent "Kein Wert"</strong></td><td>${histogram.Statistic.NoValuePercent.toFixed(2)} %</td></tr>`;
                    if (histogram.Statistic.BelowHistogramMinCount !== undefined) resultsHtml += `<tr><td><strong>Anzahl unter Min-Wert</strong></td><td>${histogram.Statistic.BelowHistogramMinCount}</td></tr>`;
                    if (histogram.Statistic.BelowHistogramMinPercent !== undefined) resultsHtml += `<tr><td><strong>Prozent unter Min-Wert</strong></td><td>${histogram.Statistic.BelowHistogramMinPercent.toFixed(2)} %</td></tr>`;
                    if (histogram.Statistic.AboveHistogramMaxCount !== undefined) resultsHtml += `<tr><td><strong>Anzahl über Max-Wert</strong></td><td>${histogram.Statistic.AboveHistogramMaxCount}</td></tr>`;
                    if (histogram.Statistic.AboveHistogramMaxPercent !== undefined) resultsHtml += `<tr><td><strong>Prozent über Max-Wert</strong></td><td>${histogram.Statistic.AboveHistogramMaxPercent.toFixed(2)} %</td></tr>`;
                    if (histogram.Statistic.MinValueAbsolute !== undefined) resultsHtml += `<tr><td><strong>Absoluter Minimalwert</strong></td><td>${histogram.Statistic.MinValueAbsolute.toFixed(3)}</td></tr>`;
                    if (histogram.Statistic.MaxValueAbsolute !== undefined) resultsHtml += `<tr><td><strong>Absoluter Maximalwert</strong></td><td>${histogram.Statistic.MaxValueAbsolute.toFixed(3)}</td></tr>`;
                    if (histogram.Statistic.MinValueHistogram !== undefined) resultsHtml += `<tr><td><strong>Histogramm Minimalwert</strong></td><td>${histogram.Statistic.MinValueHistogram.toFixed(3)}</td></tr>`;
                    if (histogram.Statistic.MaxValueHistogram !== undefined) resultsHtml += `<tr><td><strong>Histogramm Maximalwert</strong></td><td>${histogram.Statistic.MaxValueHistogram.toFixed(3)}</td></tr>`;
                    resultsHtml += '</table>';
                    resultsHtml += `</div>`; // Closing panel div for Statistik content
                  }

                  if (Array.isArray(histogram.Entries) && histogram.Entries.length > 0) {
                    resultsHtml += `<h4 class="accordion">Details für ${histogram.Entries.length} Klassen anzeigen</h4>`;
                    resultsHtml += `<div class="panel">`;
                    resultsHtml += `<table class="results-table histogram-entries-table"><thead><tr><th>Untergrenze</th><th>Obergrenze</th><th>Anzahl</th><th>Prozent</th></tr></thead><tbody>`;
                    histogram.Entries.forEach(entry => {
                      resultsHtml += `<tr>`;
                      if (entry.LowerBound !== undefined) resultsHtml += `<td>${entry.LowerBound.toFixed(3)}</td>`;
                      if (entry.UpperBound !== undefined) resultsHtml += `<td>${entry.UpperBound.toFixed(3)}</td>`;
                      if (entry.BinCount !== undefined) resultsHtml += `<td>${entry.BinCount}</td>`;
                      if (entry.BinPercent !== undefined) resultsHtml += `<td>${entry.BinPercent.toFixed(2)} %</td>`;
                      resultsHtml += `</tr>`;
                    });
                    resultsHtml += `</tbody></table></div>`;
                  } else {
                    resultsHtml += '<p>Dieses Histogramm enthält keine Klassen.</p>';
                  }
                });
              } else {
                resultsHtml += '<p class="status-message">Keine Histogramm-Ergebnisse verfügbar.</p>';
              }
            } else {
              resultsHtml += '<p class="status-message">Keine Analyseergebnisse verfügbar.</p>';
            }

            displayResult('success', resultsHtml);
          } else {
            let errorHtml = `<p class="status-message">Erfolgreiche HTTP-Antwort (${response.status}), aber die erwarteten Daten wurden nicht gefunden.</p>`;
            if (rawText !== null) {
              errorHtml += `<br>Antwort vom Server (Roh):<br><pre>${rawText}</pre>`;
            }
            displayResult('error', errorHtml);
          }
        } catch (error) {
          console.error("Fehler bei Abruf oder Verarbeitung:", error);
          displayResult('error', `<p class="status-message">Fehler beim Abfragen der API oder während der Verarbeitung:</p><p>${error.message}</p>`);
        }
      });

      // Listener, um UTM-Felder zu leeren, wenn Lon/Lat aktiv bearbeitet wird
      longitudeInput.addEventListener('input', () => {
        if (longitudeInput.value.trim() !== "" || latitudeInput.value.trim() !== "") {
          zoneInput.value = "";
          eastingInput.value = "";
          northingInput.value = "";
        }
      });
      latitudeInput.addEventListener('input', () => {
        if (longitudeInput.value.trim() !== "" || latitudeInput.value.trim() !== "") {
          zoneInput.value = "";
          eastingInput.value = "";
          northingInput.value = "";
        }
      });

      // Listener, um Lon/Lat-Felder zu leeren, wenn UTM aktiv bearbeitet wird
      zoneInput.addEventListener('input', () => {
        if (zoneInput.value.trim() !== "" || eastingInput.value.trim() !== "" || northingInput.value.trim() !== "") {
          longitudeInput.value = "";
          latitudeInput.value = "";
        }
      });
      eastingInput.addEventListener('input', () => {
        if (eastingInput.value.trim() !== "" || zoneInput.value.trim() !== "" || northingInput.value.trim() !== "") {
          longitudeInput.value = "";
          latitudeInput.value = "";
        }
      });
      northingInput.addEventListener('input', () => {
        if (northingInput.value.trim() !== "" || eastingInput.value.trim() !== "" || zoneInput.value.trim() !== "") {
          longitudeInput.value = "";
          latitudeInput.value = "";
        }
      });
    });
  </script>
  <div class="container">
    <hr>

    <p class="copyright">© 2025 - Höhendaten für Deutschland</p>
  </div>
</body>
</html>
