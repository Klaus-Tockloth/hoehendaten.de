<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quelldaten (Dienst)</title>
  <meta name="description" content="Generieren Sie Roh-Höhendaten (GeoTIFF) für einen Kartenausschnitt in Deutschland basierend auf Koordinaten.">
  <meta name="keywords" content="Höhendaten, Quelldaten, Rohdaten, DGM, UTM, Lon/Lat, Abbildung, Visualisierung, Geodaten, Deutschland, GeoTIFF">
  <meta name="robots" content="index, follow">
  <link rel="stylesheet" href="style.css">
  <style>
    .results-table pre {
      max-height: 12em;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      padding: 5px;
      border: 1px solid #ddd;
      background-color: #f9f9f9;
    }

    .input-group textarea {
      width: calc(100% - 10px);
      box-sizing: border-box;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
    }

    .input-group input[type="text"],
    .input-group input[type="number"],
    .input-group select {
      width: calc(100% - 10px);
      box-sizing: border-box;
    }

    .input-group.color-scheme-input-group {
        display: block;
    }

    .input-group.color-scheme-input-group label {
        width: auto;
        margin-bottom: 5px;
    }

    .input-group.color-scheme-input-group input[type="file"],
    .input-group.color-scheme-input-group textarea {
        width: 100%; /* volle Breite für Dateiauswahl und Textarea */
        box-sizing: border-box;
    }

    .input-group.color-scheme-input-group input[type="file"] {
        margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <nav>
    <ul>
      <li>
        <a href="index.html">Start</a>
      </li>

      <li>
        <a href="karte.html">Karte</a>
      </li>

      <li class="dropdown">
        <a href="javascript:void(0);" class="dropbtn">Abbildungen&nbsp;›</a>
        <ul class="dropdown-content">
          <li>
            <a href="abbildung-allgemein.html">Allgemein</a>
          </li>

          <li>
            <a href="abbildung-hoehenschichtlinien.html">Höhenschichtlinien</a>
          </li>

          <li>
            <a href="abbildung-schummerung.html">Schummerung</a>
          </li>

          <li>
            <a href="abbildung-kolorierung.html">Kolorierung</a>
          </li>

          <li>
            <a href="abbildung-farbrelief.html">Farbrelief</a>
          </li>

          <li>
            <a href="abbildung-hangneigung.html">Hangneigung</a>
          </li>

          <li>
            <a href="abbildung-hangexposition.html">Hangexposition</a>
          </li>

          <li>
            <a href="abbildung-gelaenderauheit.html">Geländerauheit</a>
          </li>

          <li>
            <a href="abbildung-tri.html">TRI (Ruggedness)</a>
          </li>

          <li>
            <a href="abbildung-tpi.html">TPI (Position)</a>
          </li>
        </ul>
      </li>

      <li>
        <a href="grundlagen.html">Grundlagen</a>
      </li>

      <li class="dropdown">
        <a href="javascript:void(0);" class="dropbtn">Dienste&nbsp;›</a>
        <ul class="dropdown-content">
          <li>
            <a href="dienst-punkt.html">Punkt Lon / Lat</a>
          </li>

          <li>
            <a href="dienst-punkt_utm.html">Punkt UTM</a>
          </li>

          <li>
            <a href="dienst-quelldaten.html">Quelldaten GeoTIFF</a>
          </li>

          <li>
            <a href="dienst-gpx.html">GPX-Datei</a>
          </li>

          <li>
            <a href="dienst-gpx-analyse.html">GPX-Analyse</a>
          </li>

          <li>
            <a href="dienst-hoehenschichtlinien.html">Höhenschichtlinien</a>
          </li>

          <li>
            <a href="dienst-schummerung.html">Schummerung</a>
          </li>

          <li>
            <a href="dienst-kolorierung.html">Kolorierung</a>
          </li>

          <li>
            <a href="dienst-farbrelief.html">Farbrelief</a>
          </li>

          <li>
            <a href="dienst-hangneigung.html">Hangneigung</a>
          </li>

          <li>
            <a href="dienst-hangexposition.html">Hangexposition</a>
          </li>

          <li>
            <a href="dienst-gelaenderauheit.html">Geländerauheit</a>
          </li>

          <li>
            <a href="dienst-tri.html">TRI (Ruggedness)</a>
          </li>

          <li>
            <a href="dienst-tpi.html">TPI (Position)</a>
          </li>
        </ul>
      </li>

      <li class="dropdown">
        <a href="javascript:void(0);" class="dropbtn">API&nbsp;›</a>
        <ul class="dropdown-content">
          <li>
            <a href="api-allgemein.html">Allgemein</a>
          </li>

          <li>
            <a href="api-pointrequest.html">PointRequest</a>
          </li>

          <li>
            <a href="api-utmpointrequest.html">UTMPointRequest</a>
          </li>

          <li>
            <a href="api-rawtifrequest.html">RawTIFRequest</a>
          </li>

          <li>
            <a href="api-gpxrequest.html">GPXRequest</a>
          </li>

          <li>
            <a href="api-gpxanalyzerequest.html">GPXAnalyseRequest</a>
          </li>

          <li>
            <a href="api-contoursrequest.html">ContoursRequest</a>
          </li>

          <li>
            <a href="api-hillshaderequest.html">HillshadeRequest</a>
          </li>

          <li>
            <a href="api-colorreliefrequest.html">ColorReliefRequest</a>
          </li>

          <li>
            <a href="api-sloperequest.html">SlopeRequest</a>
          </li>

          <li>
            <a href="api-aspectrequest.html">AspectRequest</a>
          </li>

          <li>
            <a href="api-roughnessrequest.html">RoughnessRequest</a>
          </li>

          <li>
            <a href="api-trirequest.html">TRIRequest</a>
          </li>

          <li>
            <a href="api-tpirequest.html">TPIRequest</a>
          </li>
        </ul>
      </li>

      <li>
        <a href="impressum.html">Impressum</a>
      </li>
    </ul>
  </nav>

  <div class="container">
    <h3>Quelldaten für einen Kartenausschnitt von 1x1 km</h3>

    <p>Der Referenzpunkt muss im UTM-Koordinatensystem angegeben werden. Die originalen Höhendaten werden für die Kachel abgerufen, in der sich der Referenzpunkt
    befindet. Die Ausgabe erfolgt im GeoTIFF-Format.</p>
    <!-- Bereich für die Eingabefelder -->

    <div class="input-section section-box">
      <p>UTM-Koordinaten</p>

      <div class="input-group">
        <label for="zone">Zone</label> <input type="number" id="zone" value="32" min="32" max="33">
      </div>

      <div class="input-group">
        <label for="easting">Easting</label> <input type="text" id="easting" value="497500.0">
      </div>

      <div class="input-group">
        <label for="northing">Northing</label> <input type="text" id="northing" value="5670500.0">
      </div>
    </div>
    <!-- Bereich für den Button -->

    <div class="button-section section-box">
      <button id="queryButton">Abfrage der Quelldaten</button>
    </div>
    <!-- Bereich für die Ausgabe -->

    <div class="output-section section-box">
      <div id="results">
      </div>
    </div>
  </div>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const zoneInput = document.getElementById('zone');
    const eastingInput = document.getElementById('easting');
    const northingInput = document.getElementById('northing');

    const queryButton = document.getElementById('queryButton');
    const resultsDiv = document.getElementById('results');

    const apiUrl = 'https://api.hoehendaten.de:14444/v1/rawtif';

    /**
     * Zeigt eine Meldung im Ergebnisbereich an.
     * @param {string} className - Die CSS-Klasse für den Ergebnisbereich (z.B. 'loading', 'success', 'error').
     * @param {string} htmlContent - Der HTML-Inhalt, der angezeigt werden soll.
     */
    function displayResult(className, htmlContent) {
        resultsDiv.className = className;
        resultsDiv.innerHTML = htmlContent;
    }

    /**
     * Konvertiert einen Base64-String in einen Binärstring.
     * @param {string} base64 - Der Base64-kodierte String.
     * @returns {string|null} Der dekodierte Binärstring oder null bei Fehler.
     */
    function base64ToBinaryString(base64) {
        try {
            // Einfache Validierung des Base64-Strings
            if (typeof base64 !== 'string' || base64.length % 4 !== 0 || /[^0-9a-zA-Z+/=]/g.test(base64)) {
                console.error("Ungültiger Base64 String:", base64);
                return null;
            }
            return atob(base64);
        } catch (e) {
            console.error("Fehler beim Dekodieren von Base64:", e);
            return null;
        }
    }

    queryButton.addEventListener('click', async () => {
        const zone = parseInt(zoneInput.value, 10);
        const easting = parseFloat(eastingInput.value);
        const northing = parseFloat(northingInput.value);

        // Überprüfung der UTM-Eingaben
        if (isNaN(zone) || (zone !== 32 && zone !== 33) || isNaN(easting) || isNaN(northing) ||
            zoneInput.value.trim() === "" || eastingInput.value.trim() === "" || northingInput.value.trim() === "") {
            displayResult('error', '<p class="status-message">Fehler: Bitte geben Sie gültige UTM-Koordinaten (Zone 32 oder 33, Easting, Northing) ein.</p>');
            return;
        }

        displayResult('loading', '<p class="status-message">Lade ... Sende Anfrage an den Dienst ...</p>');

        const requestPayload = {
            Type: "RawTIFRequest",
            // Generiert eine eindeutige ID für die Anfrage
            ID: "WebApp-RawTIF-" + Date.now() + "-" + Math.random().toString(36).substring(7),
            Attributes: {
                Zone: zone,
                Easting: easting,
                Northing: northing
            }
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Accept-Encoding': 'gzip'
                },
                body: JSON.stringify(requestPayload)
            });

            let data = null;
            let rawText = null;

            // Versucht, die Antwort als JSON zu parsen, speichert aber den Roh-Text
            try {
                rawText = await response.text();
                data = JSON.parse(rawText);
                console.log("API-Antwort (geparstes JSON):", data);
            } catch (jsonError) {
                console.warn("JSON-Parsen fehlgeschlagen:", jsonError);
                console.log("Rohe Antwort (Text):", rawText);
            }

            if (!response.ok) {
                let errorHtml = `<p class="status-message">Serverfehler mit Status ${response.status}:</p>`;
                if (data && data.Attributes && data.Attributes.IsError === true) {
                    const errorAttributes = data.Attributes;
                    errorHtml += '<table class="results-table">';
                    // Zeigt relevante Anforderungsattribute aus der Fehlerantwort an
                    if (errorAttributes.Zone !== undefined && errorAttributes.Zone !== 0) errorHtml += `<tr><td><strong>Zone</strong></td><td>${errorAttributes.Zone}</td></tr>`;
                    if (errorAttributes.Easting !== undefined && errorAttributes.Easting !== 0) errorHtml += `<tr><td><strong>Easting</strong></td><td>${errorAttributes.Easting}</td></tr>`;
                    if (errorAttributes.Northing !== undefined && errorAttributes.Northing !== 0) errorHtml += `<tr><td><strong>Northing</strong></td><td>${errorAttributes.Northing}</td></tr>`;

                    if (errorAttributes.Error) {
                        const errorDetail = errorAttributes.Error;
                        if (errorDetail.Code !== undefined) errorHtml += `<tr><td><strong>Fehlercode</strong></td><td>${errorDetail.Code}</td></tr>`;
                        if (errorDetail.Title !== undefined) errorHtml += `<tr><td><strong>Fehlertitel</strong></td><td>${errorDetail.Title}</td></tr>`;
                        if (errorDetail.Detail !== undefined) errorHtml += `<tr><td><strong>Fehlerdetail</strong></td><td>${errorDetail.Detail}</td></tr>`;
                    }
                    errorHtml += '</table>';
                } else if (rawText !== null) {
                    errorHtml += `<br>Antwort vom Server (Roh):<br><pre>${rawText}</pre>`;
                } else {
                    errorHtml += `<br>Konnte die Antwort vom Server nicht lesen.`;
                }
                displayResult('error', errorHtml);
                return;
            }

            // Verarbeitung der erfolgreichen Antwort
            if (data && data.Attributes) {
                if (data.Attributes.IsError === true) {
                    // Anwendungsfehler, auch wenn HTTP-Status OK war
                    const errorAttributes = data.Attributes;
                    let errorHtml = '<p class="status-message">Erfolgreiche HTTP-Antwort, aber Anwendungsfehler gemeldet.</p>';
                    errorHtml += '<table class="results-table">';
                    if (errorAttributes.Zone !== undefined && errorAttributes.Zone !== 0) errorHtml += `<tr><td><strong>Zone</strong></td><td>${errorAttributes.Zone}</td></tr>`;
                    if (errorAttributes.Easting !== undefined && errorAttributes.Easting !== 0) errorHtml += `<tr><td><strong>Easting</strong></td><td>${errorAttributes.Easting}</td></tr>`;
                    if (errorAttributes.Northing !== undefined && errorAttributes.Northing !== 0) errorHtml += `<tr><td><strong>Northing</strong></td><td>${errorAttributes.Northing}</td></tr>`;

                    if (errorAttributes.Error) {
                        const errorDetail = errorAttributes.Error;
                        errorHtml += '<tr><td colspan="2"><strong>Fehlerdetails:</strong></td></tr>';
                        if (errorDetail.Code !== undefined) errorHtml += `<tr><td><strong>Code</strong></td><td>${errorDetail.Code}</td></tr>`;
                        if (errorDetail.Title !== undefined) errorHtml += `<tr><td><strong>Titel</strong></td><td>${errorDetail.Title}</td></tr>`;
                        if (errorDetail.Detail !== undefined) errorHtml += `<tr><td><strong>Detail</strong></td><td>${errorDetail.Detail}</td></tr>`;
                    }
                    errorHtml += '</table>';
                    console.error("API-Anwendungsfehler trotz OK-Antwort:", data.Attributes);
                    displayResult('error', errorHtml);
                    return;
                }

                let resultsHtml = '<p class="status-message">Quelldaten erfolgreich verarbeitet:</p>';
                resultsHtml += '<table class="results-table">';
                const attributes = data.Attributes;
                // Zeigt die verwendeten Eingabeparameter an
                if (attributes.Zone !== undefined && attributes.Zone !== 0) resultsHtml += `<tr><td><strong>Zone</strong></td><td>${attributes.Zone}</td></tr>`;
                if (attributes.Easting !== undefined && attributes.Easting !== 0) resultsHtml += `<tr><td><strong>Easting</strong></td><td>${attributes.Easting}</td></tr>`;
                if (attributes.Northing !== undefined && attributes.Northing !== 0) resultsHtml += `<tr><td><strong>Northing</strong></td><td>${attributes.Northing}</td></tr>`;
                resultsHtml += '</table>';

                if (attributes.RawTIFs && Array.isArray(attributes.RawTIFs) && attributes.RawTIFs.length > 0) {
                    resultsHtml += '<h4 style="margin-top: 1.5em;">Generierte Quelldaten (GeoTIFF):</h4>';
                    attributes.RawTIFs.forEach((rawTif, index) => {
                        resultsHtml += `<h4 style="margin-top: 1.5em;">Kachel ${index + 1}</h4>`;
                        resultsHtml += '<table class="results-table">';
                        if (rawTif.TileIndex !== undefined) resultsHtml += `<tr><td><strong>Tile Index</strong></td><td>${rawTif.TileIndex}</td></tr>`;
                        if (rawTif.Actuality !== undefined) resultsHtml += `<tr><td><strong>Aktualität</strong></td><td>${rawTif.Actuality}</td></tr>`;
                        if (rawTif.Origin !== undefined) resultsHtml += `<tr><td><strong>Ursprung</strong></td><td>${rawTif.Origin}</td></tr>`;
                        if (rawTif.Attribution !== undefined) resultsHtml += `<tr><td><strong>Attribution</strong></td><td>${rawTif.Attribution}</td></tr>`;
                        if (rawTif.DataFormat !== undefined) resultsHtml += `<tr><td><strong>Format</strong></td><td>${rawTif.DataFormat}</td></tr>`;

                        // Zeigt Bounding Box an, falls verfügbar
                        if (rawTif.BoundingBox && (rawTif.BoundingBox.MinLon !== 0 || rawTif.BoundingBox.MinLat !== 0 || rawTif.BoundingBox.MaxLon !== 0 || rawTif.BoundingBox.MaxLat !== 0)) {
                            resultsHtml += `<tr><td colspan="2"><strong>Bounding Box (WGS84):</strong></td></tr>`;
                            resultsHtml += `<tr><td>MinLon</td><td>${rawTif.BoundingBox.MinLon}</td></tr>`;
                            resultsHtml += `<tr><td>MaxLon</td><td>${rawTif.BoundingBox.MaxLon}</td></tr>`;
                            resultsHtml += `<tr><td>MinLat</td><td>${rawTif.BoundingBox.MinLat}</td></tr>`;
                            resultsHtml += `<tr><td>MaxLat</td><td>${rawTif.BoundingBox.MaxLat}</td></tr>`;
                        }
                        resultsHtml += '</table>';

                        if (rawTif.Data && rawTif.TileIndex && rawTif.DataFormat) {
                            const decodedBinaryString = base64ToBinaryString(rawTif.Data);
                            if (decodedBinaryString) {
                                const byteNumbers = new Array(decodedBinaryString.length);
                                for (let i = 0; i < decodedBinaryString.length; i++) {
                                    byteNumbers[i] = decodedBinaryString.charCodeAt(i);
                                }
                                const byteArray = new Uint8Array(byteNumbers);

                                const mimeType = 'image/tiff'; // Für GeoTIFF
                                const fileExtension = 'tif';

                                const blob = new Blob([byteArray], { type: mimeType });
                                const downloadUrl = URL.createObjectURL(blob);

                                // Dateiname: TileIndex + optionaler Ursprung + Format-Erweiterung
                                const originPart = rawTif.Origin ? `.${rawTif.Origin.toLowerCase()}` : '';
                                const outputFileName = `${rawTif.TileIndex}${originPart}.quelldaten.${fileExtension}`;

                                resultsHtml += `<p class="download-link-area"><a href="${downloadUrl}" download="${outputFileName}">Download '${outputFileName}'</a></p>`;
                            } else {
                                resultsHtml += `<p class="status-message error-message">Fehler: Quelldaten (Base64) für Kachel ${rawTif.TileIndex} konnten nicht dekodiert werden.</p>`;
                            }
                        } else {
                            resultsHtml += `<p class="status-message error-message">Keine Daten zum Herunterladen für Kachel ${rawTif.TileIndex || 'Unbekannt'}.</p>`;
                        }
                    });
                } else {
                    resultsHtml += '<p>Keine Quelldaten in der Antwort enthalten.</p>';
                }
                displayResult('success', resultsHtml);

            } else {
                let errorHtml = `<p class="status-message">Erfolgreiche HTTP-Antwort (${response.status}), aber die erwarteten Daten wurden nicht gefunden.</p>`;
                if (rawText !== null) {
                    errorHtml += `<br>Antwort vom Server (Roh):<br><pre>${rawText}</pre>`;
                }
                displayResult('error', errorHtml);
            }

        } catch (error) {
            console.error("Fehler bei Abruf oder Verarbeitung:", error);
            displayResult('error', `<p class="status-message">Fehler beim Abfragen der API oder während der Verarbeitung:</p><p>${error.message}</p>`);
        }
    });
  });

  </script>
  <div class="container">
    <hr>

    <p class="copyright">© 2025 - Höhendaten für Deutschland</p>
  </div>
</body>
</html>
