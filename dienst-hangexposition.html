<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dienst - Hangexposition</title>
  <meta name="description" content=
  "Generieren Sie Hangexpositionsabbildungen (Aspect) für einen Kartenausschnitt in Deutschland basierend auf Koordinaten, einem Algorithmus und einem Farbtextschema.">
  <meta name="keywords" content=
  "Höhendaten, Hangexposition, Aspect, DGM, UTM, Lon/Lat, Abbildung, Visualisierung, Geodaten, Deutschland, Farbschema, Horn, ZevenbergenThorne">
  <meta name="robots" content="index, follow">
  <link rel="stylesheet" href="style.css">
  <style>
    .results-table pre {
      max-height: 12em;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      padding: 5px;
      border: 1px solid #ddd;
      background-color: #f9f9f9;
    }
    
    .input-group textarea {
      width: calc(100% - 10px);
      box-sizing: border-box;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 5px;
    }
    
    .input-group input[type="text"],
    .input-group input[type="number"],
    .input-group select {
      width: calc(100% - 10px);
      box-sizing: border-box;
    }

    .input-group.color-scheme-input-group {
        display: block;
    }

    .input-group.color-scheme-input-group label {
        width: auto;
        margin-bottom: 5px;
    }

    .input-group.color-scheme-input-group input[type="file"],
    .input-group.color-scheme-input-group textarea {
        width: 100%; /* volle Breite für Dateiauswahl und Textarea */
        box-sizing: border-box;
    }

    .input-group.color-scheme-input-group input[type="file"] {
        margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <nav>
    <ul>
      <li>
        <a href="index.html">Start</a>
      </li>

      <li>
        <a href="karte.html">Karte</a>
      </li>

      <li class="dropdown">
        <a href="javascript:void(0);" class="dropbtn">Abbildungen ›</a>
        <ul class="dropdown-content">
          <li>
            <a href="abbildung-allgemein.html">Allgemein</a>
          </li>

          <li>
            <a href="abbildung-hoehenschichtlinien.html">Höhenschichtlinien</a>
          </li>

          <li>
            <a href="abbildung-schummerung.html">Schummerung</a>
          </li>

          <li>
            <a href="abbildung-kolorierung.html">Kolorierung</a>
          </li>

          <li>
            <a href="abbildung-hangneigung.html">Hangneigung</a>
          </li>

          <li>
            <a href="abbildung-hangexposition.html">Hangexposition</a>
          </li>
          <!--
          <li>
            <a href="abbildung-tpi.html">TPI - Topographic Position Index</a>
          </li>
          <li>
            <a href="abbildung-tri.html">TRI - Topographic Ruggedness Index</a>
          </li>
          <li>
            <a href="abbildung-ri.html">RI - Roughness Index</a>
          </li>
           -->
        </ul>
      </li>

      <li>
        <a href="dud.html">DuD</a>
      </li>

      <li class="dropdown">
        <a href="javascript:void(0);" class="dropbtn">Dienste ›</a>
        <ul class="dropdown-content">
          <li>
            <a href="dienst-punkt.html">Punkt Lon / Lat</a>
          </li>

          <li>
            <a href="dienst-punkt_utm.html">Punkt UTM</a>
          </li>

          <li>
            <a href="dienst-gpx.html">GPX-Datei</a>
          </li>

          <li>
            <a href="dienst-gpx-analyse.html">GPX-Analyse</a>
          </li>

          <li>
            <a href="dienst-hoehenschichtlinien.html">Höhenschichtlinien</a>
          </li>

          <li>
            <a href="dienst-schummerung.html">Schummerung</a>
          </li>

          <li>
            <a href="dienst-kolorierung.html">Kolorierung</a>
          </li>

          <li>
            <a href="dienst-hangneigung.html">Hangneigung</a>
          </li>

          <li>
            <a href="dienst-hangexposition.html">Hangexposition</a>
          </li>
        </ul>
      </li>

      <li class="dropdown">
        <a href="javascript:void(0);" class="dropbtn">API ›</a>
        <ul class="dropdown-content">
          <li>
            <a href="api-allgemein.html">Allgemein</a>
          </li>

          <li>
            <a href="api-pointrequest.html">PointRequest</a>
          </li>

          <li>
            <a href="api-utmpointrequest.html">UTMPointRequest</a>
          </li>

          <li>
            <a href="api-gpxrequest.html">GPXRequest</a>
          </li>

          <li>
            <a href="api-gpxanalyzerequest.html">GPXAnalyseRequest</a>
          </li>

          <li>
            <a href="api-contoursrequest.html">ContoursRequest</a>
          </li>

          <li>
            <a href="api-hillshaderequest.html">HillshadeRequest</a>
          </li>

          <li>
            <a href="api-sloperequest.html">SlopeRequest</a>
          </li>

          <li>
            <a href="api-aspectrequest.html">AspectRequest</a>
          </li>
        </ul>
      </li>

      <li>
        <a href="impressum.html">Impressum</a>
      </li>
    </ul>
  </nav>

  <div class="container">
    <h3>Hangexposition für einen Kartenausschnitt von 1x1 km</h3>

    <p>Der Referenzpunkt kann in den Koordinatensystemen Lon/Lat oder UTM angegeben werden. Die Hangexposition wird für die Kachel generiert, in der sich der
    Referenzpunkt befindet. Die Ausgabe erfolgt im GeoTIFF-Format (wenn UTM-Koordinaten eingegeben wurden) oder im PNG-Format (wenn Lon/Lat-Koordinaten eingegeben
    wurden). Zusätzlich muss ein Farbtextschema für die Kolorierung angegeben werden.</p>
    <!-- Bereich für die Eingabefelder -->

    <div class="input-section section-box">
      <p>Option 1: Lon/Lat-Koordinaten</p>
      <!-- Hegekopf, Edersee, Hessen -->

      <div class="input-group">
        <label for="longitude">Longitude</label> <input type="text" id="longitude" value="8.964229">
      </div>

      <div class="input-group">
        <label for="latitude">Latitude</label> <input type="text" id="latitude" value="51.185913">
      </div>

      <hr style="border-top: 1px solid #ddd; margin-top: 1em; margin-bottom: 1em;">

      <p>Option 2: UTM-Koordinaten</p>

      <div class="input-group">
        <label for="zone">Zone</label> <input type="number" id="zone" value="" min="32" max="33">
      </div>

      <div class="input-group">
        <label for="easting">Easting</label> <input type="text" id="easting" value="">
      </div>

      <div class="input-group">
        <label for="northing">Northing</label> <input type="text" id="northing" value="">
      </div>

      <hr style="border-top: 1px solid #ddd; margin-top: 1em; margin-bottom: 1em;">

      <div class="input-group">
        <label for="gradientAlgorithm">Algorithmus</label> <select id="gradientAlgorithm">
          <option value="Horn">
            Horn
          </option>
          <option value="ZevenbergenThorne" selected>
            ZevenbergenThorne
          </option>
        </select>
      </div>
      <!-- Kombinierter Bereich für Farbdatei und Farbschema -->

      <div class="input-group color-scheme-input-group">
        <label for="colorTextFileContent">Farbschema</label> <input type="file" id="colorFileInput" accept=".txt"> 

        <textarea id="colorTextFileContent" rows="10"># Winkel- und Farbschema für die Abbildung von Hangexpositionen
# Winkel- und Farbschema für die Abbildung von Hangexpositionen.
# Musterdefinition als Basis für eigene Anpassungen.
# Format: Wert Rot Grün Blau Alpha

# Nord (Teil 1), Schatten: 0 ... &lt;22.5, Farbe kühl
# Nordost, Schatten: 22.5 ... &lt;67.5, Farbe Übergang zu morgens
# Ost, Morgensonne: 67.5 ... &lt;112.5, Farbe hell, gelblich
# Südost, Sonne: 112.5 ... &lt;157.5, Farbe warm werdend
# Süd, Sonne: 157.5 ... &lt;202.5, Farbe warm, kräftig
# Südwest, Sonne: 202.5 ... &lt;247.5, Farbe weiterhin warm
# West, Nachmittagssonne: 247.5 ... &lt;292.5, Farbe abkühlend
# Nordwest, Schatten: 292.5 ... &lt;337.5, Farbe kühl
# Nord (Teil 2), Schatten: 337.5 ... &lt;360.0, Farbe kühl

0 190 190 220 255
22.5 180 220 200 255
67.5 255 255 180 255
112.5 255 220 160 255
157.5 255 180 120 255
202.5 245 190 130 255
247.5 200 210 230 255
292.5 190 190 220 255
337.5 190 190 220 255
360.0 190 190 220 255
nv 0 0 0 0</textarea>
      </div>
    </div>
    <!-- Bereich für den Button -->

    <div class="button-section section-box">
      <button id="queryButton">Abfrage der Hangexposition</button>
    </div>
    <!-- Bereich für die Ausgabe -->

    <div class="output-section section-box">
      <div id="results">
      </div>
    </div>
  </div>
  <script>
         document.addEventListener('DOMContentLoaded', () => {
             const longitudeInput = document.getElementById('longitude');
             const latitudeInput = document.getElementById('latitude');
             const zoneInput = document.getElementById('zone');
             const eastingInput = document.getElementById('easting');
             const northingInput = document.getElementById('northing');

             const gradientAlgorithmSelect = document.getElementById('gradientAlgorithm');
             const colorFileInput = document.getElementById('colorFileInput');
             const colorTextFileContentInput = document.getElementById('colorTextFileContent');

             const queryButton = document.getElementById('queryButton');
             const resultsDiv = document.getElementById('results');

             const apiUrl = 'https://api.hoehendaten.de:14444/v1/aspect';

             function displayResult(className, htmlContent) {
                 resultsDiv.className = className;
                 resultsDiv.innerHTML = htmlContent;
             }

             // Function to convert Base64 string to binary string (for Blob)
             function base64ToBinaryString(base64) {
                try {
                    // Check if base64 string is potentially malformed before decoding
                    if (typeof base64 !== 'string' || base64.length % 4 !== 0 || /[^0-9a-zA-Z+/=]/g.test(base64)) {
                         console.error("Ungültiger Base64 String:", base64);
                         return null;
                    }
                    return atob(base64);
                } catch (e) {
                    console.error("Fehler beim Dekodieren von Base64:", e);
                    return null;
                }
             }

            colorFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        colorTextFileContentInput.value = e.target.result;
                    };
                    reader.readAsText(file);
                } else {
                    // Optional: Setze den Inhalt des Textbereichs zurück, wenn keine Datei ausgewählt ist
                    // colorTextFileContentInput.value = '';
                }
            });

             queryButton.addEventListener('click', async () => {
                 const longitude = parseFloat(longitudeInput.value);
                 const latitude = parseFloat(latitudeInput.value);
                 const zone = parseInt(zoneInput.value, 10);
                 const easting = parseFloat(eastingInput.value);
                 const northing = parseFloat(northingInput.value);

                 const gradientAlgorithm = gradientAlgorithmSelect.value;
                 const colorTextFileContent = colorTextFileContentInput.value.split('\n'); // Inhalt des Textbereichs wird immer verwendet


                 let useLonLat = !isNaN(longitude) && !isNaN(latitude) && longitudeInput.value.trim() !== "" && latitudeInput.value.trim() !== "";
                 let useUtm = !isNaN(zone) && (zone === 32 || zone === 33) && !isNaN(easting) && !isNaN(northing) && zoneInput.value.trim() !== "" && eastingInput.value.trim() !== "" && northingInput.value.trim() !== "";

                 if (!useLonLat && !useUtm) {
                     displayResult('error', '<p class="status-message">Fehler: Bitte geben Sie entweder gültige Lon/Lat-Koordinaten oder gültige UTM-Koordinaten (Zone 32/33, Easting, Northing) ein.</p>');
                     return;
                 }

                 displayResult('loading', '<p class="status-message">Lade ... Sende Anfrage an den Dienst ...</p>');

                 const requestPayload = {
                     Type: "AspectRequest",
                     ID: "WebApp-Aspect-" + Date.now() + "-" + Math.random().toString(36).substring(7),
                     Attributes: {
                         Longitude: useLonLat ? longitude : 0.0,
                         Latitude: useLonLat ? latitude : 0.0,
                         Zone: useUtm ? zone : 0,
                         Easting: useUtm ? easting : 0.0,
                         Northing: useUtm ? northing : 0.0,
                         GradientAlgorithm: gradientAlgorithm,
                         ColorTextFileContent: colorTextFileContent
                     }
                 };

                 // If UTM is primary and Lon/Lat is also filled, clear Lon/Lat for the request to avoid ambiguity if the user filled both but intended UTM.
                 if (useUtm) {
                     requestPayload.Attributes.Longitude = 0.0;
                     requestPayload.Attributes.Latitude = 0.0;
                 } else if (useLonLat) { // UTM fields were not filled or invalid
                      requestPayload.Attributes.Zone = 0;
                      requestPayload.Attributes.Easting = 0.0;
                      requestPayload.Attributes.Northing = 0.0;
                 }


                 try {
                     const response = await fetch(apiUrl, {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json',
                             'Accept': 'application/json',
                             'Accept-Encoding': 'gzip'
                         },
                         body: JSON.stringify(requestPayload)
                     });

                     let data = null;
                     let rawText = null;

                     try {
                         rawText = await response.text();
                         data = JSON.parse(rawText);
                         console.log("API-Antwort (geparstes JSON):", data);
                     } catch (jsonError) {
                         console.warn("JSON-Parsen fehlgeschlagen:", jsonError);
                         console.log("Rohe Antwort (Text):", rawText);
                     }

                     if (!response.ok) {
                         let errorHtml = `<p class="status-message">Serverfehler mit Status ${response.status}:</p>`;
                         if (data && data.Attributes && data.Attributes.IsError === true) {
                             const errorAttributes = data.Attributes;
                             errorHtml += '<table class="results-table">';
                             // Display relevant request attributes from the error response
                             if (errorAttributes.Longitude !== undefined && errorAttributes.Longitude !== 0) errorHtml += `<tr><td><strong>Longitude</strong></td><td>${errorAttributes.Longitude}</td></tr>`;
                             if (errorAttributes.Latitude !== undefined && errorAttributes.Latitude !== 0) errorHtml += `<tr><td><strong>Latitude</strong></td><td>${errorAttributes.Latitude}</td></tr>`;
                             if (errorAttributes.Zone !== undefined && errorAttributes.Zone !== 0) errorHtml += `<tr><td><strong>Zone</strong></td><td>${errorAttributes.Zone}</td></tr>`;
                             if (errorAttributes.Easting !== undefined && errorAttributes.Easting !== 0) errorHtml += `<tr><td><strong>Easting</strong></td><td>${errorAttributes.Easting}</td></tr>`;
                             if (errorAttributes.Northing !== undefined && errorAttributes.Northing !== 0) errorHtml += `<tr><td><strong>Northing</strong></td><td>${errorAttributes.Northing}</td></tr>`;
                             if (errorAttributes.GradientAlgorithm !== undefined) errorHtml += `<tr><td><strong>Algorithmus</strong></td><td>${errorAttributes.GradientAlgorithm}</td></tr>`;
                             // GEÄNDERT: \\n zu \n für korrekte Zeilenumbrüche
                             if (Array.isArray(errorAttributes.ColorTextFileContent)) errorHtml += `<tr><td><strong>Farbschema</strong></td><td><pre>${errorAttributes.ColorTextFileContent.join('\n')}</pre></td></tr>`; // FIXED
                             else if (errorAttributes.ColorTextFileContent !== undefined) errorHtml += `<tr><td><strong>Farbschema</strong></td><td><pre>${errorAttributes.ColorTextFileContent}</pre></td></tr>`; // Added fallback for non-array

                             if (errorAttributes.Error) {
                                 const errorDetail = errorAttributes.Error;
                                 if (errorDetail.Code !== undefined) errorHtml += `<tr><td><strong>Fehlercode</strong></td><td>${errorDetail.Code}</td></tr>`;
                                 if (errorDetail.Title !== undefined) errorHtml += `<tr><td><strong>Fehlertitel</strong></td><td>${errorDetail.Title}</td></tr>`;
                                 if (errorDetail.Detail !== undefined) errorHtml += `<tr><td><strong>Fehlerdetail</strong></td><td>${errorDetail.Detail}</td></tr>`;
                             }
                             errorHtml += '</table>';
                         } else if (rawText !== null) {
                             errorHtml += `<br>Antwort vom Server (Roh):<br><pre>${rawText}</pre>`;
                         } else {
                             errorHtml += `<br>Konnte die Antwort vom Server nicht lesen.`;
                         }
                         displayResult('error', errorHtml);
                         return;
                     }

                     if (data && data.Attributes) {
                         if (data.Attributes.IsError === true) {
                             const errorAttributes = data.Attributes;
                             let errorHtml = '<p class="status-message">Erfolgreiche HTTP-Antwort, aber Anwendungsfehler gemeldet.</p>';
                              errorHtml += '<table class="results-table">';
                             // Display relevant request attributes from the error response
                             if (errorAttributes.Longitude !== undefined && errorAttributes.Longitude !== 0) errorHtml += `<tr><td><strong>Longitude</strong></td><td>${errorAttributes.Longitude}</td></tr>`;
                             if (errorAttributes.Latitude !== undefined && errorAttributes.Latitude !== 0) errorHtml += `<tr><td><strong>Latitude</strong></td><td>${errorAttributes.Latitude}</td></tr>`;
                             if (errorAttributes.Zone !== undefined && errorAttributes.Zone !== 0) errorHtml += `<tr><td><strong>Zone</strong></td><td>${errorAttributes.Zone}</td></tr>`;
                             if (errorAttributes.Easting !== undefined && errorAttributes.Easting !== 0) errorHtml += `<tr><td><strong>Easting</strong></td><td>${errorAttributes.Easting}</td></tr>`;
                             if (errorAttributes.Northing !== undefined && errorAttributes.Northing !== 0) errorHtml += `<tr><td><strong>Northing</strong></td><td>${errorAttributes.Northing}</td></tr>`;
                             if (errorAttributes.GradientAlgorithm !== undefined) errorHtml += `<tr><td><strong>Algorithmus</strong></td><td>${errorAttributes.GradientAlgorithm}</td></tr>`;
                             // GEÄNDERT: \\n zu \n für korrekte Zeilenumbrüche
                             if (Array.isArray(errorAttributes.ColorTextFileContent)) errorHtml += `<tr><td><strong>Farbschema</strong></td><td><pre>${errorAttributes.ColorTextFileContent.join('\n')}</pre></td></tr>`; // FIXED
                             else if (errorAttributes.ColorTextFileContent !== undefined) errorHtml += `<tr><td><strong>Farbschema</strong></td><td><pre>${errorAttributes.ColorTextFileContent}</pre></td></tr>`; // Added fallback for non-array

                             if (errorAttributes.Error) {
                                 const errorDetail = errorAttributes.Error;
                                 errorHtml += '<tr><td colspan="2"><strong>Fehlerdetails:</strong></td></tr>';
                                 if (errorDetail.Code !== undefined) errorHtml += `<tr><td><strong>Code</strong></td><td>${errorDetail.Code}</td></tr>`;
                                 if (errorDetail.Title !== undefined) errorHtml += `<tr><td><strong>Titel</strong></td><td>${errorDetail.Title}</td></tr>`;
                                 if (errorDetail.Detail !== undefined) errorHtml += `<tr><td><strong>Detail</strong></td><td>${errorDetail.Detail}</td></tr>`;
                             }
                             errorHtml += '</table>';
                             console.error("API-Anwendungsfehler trotz OK-Antwort:", data.Attributes);
                             displayResult('error', errorHtml);
                             return;
                         }

                         let resultsHtml = '<p class="status-message">Hangexposition erfolgreich verarbeitet:</p>';
                         resultsHtml += '<table class="results-table">';
                         const attributes = data.Attributes;
                          // Display input parameters that were used
                         if (attributes.Longitude !== undefined && attributes.Longitude !== 0) resultsHtml += `<tr><td><strong>Longitude</strong></td><td>${attributes.Longitude}</td></tr>`;
                         if (attributes.Latitude !== undefined && attributes.Latitude !== 0) resultsHtml += `<tr><td><strong>Latitude</strong></td><td>${attributes.Latitude}</td></tr>`;
                         if (attributes.Zone !== undefined && attributes.Zone !== 0) resultsHtml += `<tr><td><strong>Zone</strong></td><td>${attributes.Zone}</td></tr>`;
                         if (attributes.Easting !== undefined && attributes.Easting !== 0) resultsHtml += `<tr><td><strong>Easting</strong></td><td>${attributes.Easting}</td></tr>`;
                         if (attributes.Northing !== undefined && attributes.Northing !== 0) resultsHtml += `<tr><td><strong>Northing</strong></td><td>${attributes.Northing}</td></tr>`;
                         if (attributes.GradientAlgorithm !== undefined) resultsHtml += `<tr><td><strong>Algorithmus</strong></td><td>${attributes.GradientAlgorithm}</td></tr>`;
                         if (Array.isArray(attributes.ColorTextFileContent)) resultsHtml += `<tr><td><strong>Farbschema</strong></td><td><pre>${attributes.ColorTextFileContent.join('\n')}</pre></td></tr>`; // FIXED
                         else if (attributes.ColorTextFileContent !== undefined) resultsHtml += `<tr><td><strong>Farbschema</strong></td><td><pre>${attributes.ColorTextFileContent}</pre></td></tr>`; // Added fallback for non-array

                         resultsHtml += '</table>';

                         if (attributes.Aspects && Array.isArray(attributes.Aspects) && attributes.Aspects.length > 0) {
                             resultsHtml += '<h4 style="margin-top: 1.5em;">Generierte Hangexposition(en):</h4>';
                             attributes.Aspects.forEach((aspect, index) => {
                                 resultsHtml += `<h4 style="margin-top: 1.5em;">Abbildung ${index + 1}</h4>`;
                                 resultsHtml += '<table class="results-table">';
                                 if (aspect.TileIndex !== undefined) resultsHtml += `<tr><td><strong>Tile Index</strong></td><td>${aspect.TileIndex}</td></tr>`;
                                 if (aspect.Actuality !== undefined) resultsHtml += `<tr><td><strong>Aktualität</strong></td><td>${aspect.Actuality}</td></tr>`;
                                 if (aspect.Origin !== undefined) resultsHtml += `<tr><td><strong>Ursprung</strong></td><td>${aspect.Origin}</td></tr>`;
                                 if (aspect.Attribution !== undefined) resultsHtml += `<tr><td><strong>Attribution</strong></td><td>${aspect.Attribution}</td></tr>`;
                                 if (aspect.DataFormat !== undefined) resultsHtml += `<tr><td><strong>Format</strong></td><td>${aspect.DataFormat}</td></tr>`;

                                 // Display Bounding Box if available (relevant for PNG)
                                  if (aspect.BoundingBox && (aspect.BoundingBox.MinLon !== 0 || aspect.BoundingBox.MinLat !== 0 || aspect.BoundingBox.MaxLon !== 0 || aspect.BoundingBox.MaxLat !== 0)) {
                                     resultsHtml += `<tr><td colspan="2"><strong>Bounding Box (WGS84):</strong></td></tr>`;
                                     resultsHtml += `<tr><td>MinLon</td><td>${aspect.BoundingBox.MinLon}</td></tr>`;
                                     resultsHtml += `<tr><td>MaxLon</td><td>${aspect.BoundingBox.MaxLon}</td></tr>`;
                                     resultsHtml += `<tr><td>MinLat</td><td>${aspect.BoundingBox.MinLat}</td></tr>`;
                                     resultsHtml += `<tr><td>MaxLat</td><td>${aspect.BoundingBox.MaxLat}</td></tr>`;
                                  }

                                 resultsHtml += '</table>';

                                 if (aspect.Data && aspect.TileIndex && aspect.DataFormat) {
                                     const decodedBinaryString = base64ToBinaryString(aspect.Data);
                                     if (decodedBinaryString) {
                                         const byteNumbers = new Array(decodedBinaryString.length);
                                         for (let i = 0; i < decodedBinaryString.length; i++) {
                                             byteNumbers[i] = decodedBinaryString.charCodeAt(i);
                                         }
                                         const byteArray = new Uint8Array(byteNumbers);

                                         let mimeType = 'application/octet-stream'; // Default
                                         let fileExtension = 'bin';

                                         switch(aspect.DataFormat.toLowerCase()) {
                                             case 'geotiff':
                                                 mimeType = 'image/tiff';
                                                 fileExtension = 'tif';
                                                 break;
                                             case 'png':
                                                 mimeType = 'image/png';
                                                 fileExtension = 'png';
                                                 break;
                                         }


                                         const blob = new Blob([byteArray], { type: mimeType });
                                         const downloadUrl = URL.createObjectURL(blob);

                                         // Filename: TileIndex + optional Origin + Format extension
                                         const originPart = aspect.Origin ? `.${aspect.Origin.toLowerCase()}` : '' ;
                                         const outputFileName = `${aspect.TileIndex}${originPart}.hangexposition.${fileExtension}`;

                                         resultsHtml += `<p class="download-link-area"><a href="${downloadUrl}" download="${outputFileName}">Download '${outputFileName}'</a></p>`;
                                     } else {
                                         resultsHtml += `<p class="status-message error-message">Fehler: Hangexpositionsdaten (Base64) für Tile ${aspect.TileIndex} konnten nicht dekodiert werden.</p>`;
                                     }
                                 } else {
                                     resultsHtml += `<p class="status-message error-message">Keine Daten zum Herunterladen für Tile ${aspect.TileIndex || 'Unbekannt'}.</p>`;
                                 }
                             });
                         } else {
                             resultsHtml += '<p>Keine Hangexpositions-Daten in der Antwort enthalten.</p>';
                         }
                         displayResult('success', resultsHtml);

                     } else {
                         let errorHtml = `<p class="status-message">Erfolgreiche HTTP-Antwort (${response.status}), aber die erwarteten Daten wurden nicht gefunden.</p>`;
                         if (rawText !== null) {
                            errorHtml += `<br>Antwort vom Server (Roh):<br><pre>${rawText}</pre>`;
                         }
                         displayResult('error', errorHtml);
                     }

                 } catch (error) {
                     console.error("Fehler bei Abruf oder Verarbeitung:", error);
                     displayResult('error', `<p class="status-message">Fehler beim Abfragen der API oder während der Verarbeitung:</p><p>${error.message}</p>`);
                 }
             });

            // Listener, um UTM-Felder zu leeren, wenn Lon/Lat aktiv bearbeitet wird
            longitudeInput.addEventListener('input', () => {
                if(longitudeInput.value.trim() !== "" || latitudeInput.value.trim() !== "") {
                    zoneInput.value = "";
                    eastingInput.value = "";
                    northingInput.value = "";
                }
            });
            latitudeInput.addEventListener('input', () => {
                 if(longitudeInput.value.trim() !== "" || latitudeInput.value.trim() !== "") {
                    zoneInput.value = "";
                    eastingInput.value = "";
                    northingInput.value = "";
                }
            });

            // Listener, um Lon/Lat-Felder zu leeren, wenn UTM aktiv bearbeitet wird
            zoneInput.addEventListener('input', () => {
                if(zoneInput.value.trim() !==  "" || eastingInput.value.trim() !== "" || northingInput.value.trim() !== "") {
                    longitudeInput.value = "";
                    latitudeInput.value = "";
                }
            });
            eastingInput.addEventListener('input', () => {
                 if(zoneInput.value.trim() !== "" || eastingInput.value.trim() !== "" || northingInput.value.trim() !== "") {
                    longitudeInput.value = "";
                    latitudeInput.value = "";
                }
            });
            northingInput.addEventListener('input', () => {
                if(northingInput.value.trim() !== "" || eastingInput.value.trim() !== "" || zoneInput.value.trim() !== "") {
                    longitudeInput.value = "";
                    latitudeInput.value = "";
                }
            });
         });
  </script>
  <div class="container">
    <hr>

    <p class="copyright">© 2025 - Höhendaten für Deutschland</p>
  </div>
</body>
</html>
